name: Nightly Performance

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  perf-nightly:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      PYTHONUNBUFFERED: "1"
      SDL_VIDEODRIVER: dummy
      MPLBACKEND: Agg
      PYGAME_HIDE_SUPPORT_PROMPT: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "0.5.11"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: System packages for headless
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libglib2.0-0 libgl1

      - name: Sync dependencies (locked)
        run: uv sync --all-extras --frozen

      - name: Restore trend history cache
        uses: actions/cache@v4
        with:
          path: output/benchmarks/perf/trend/history
          key: perf-trend-history-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            perf-trend-history-${{ github.ref_name }}-
            perf-trend-history-main-

      - name: Run nightly trend benchmark matrix
        id: nightly_trend
        run: |
          mkdir -p output/benchmarks/perf/trend/history
          uv run python -m robot_sf.benchmark.perf_trend \
            --matrix configs/benchmarks/perf_trend_matrix_classic_v1.yaml \
            --seed 101 \
            --history-glob 'output/benchmarks/perf/trend/history/*.json' \
            --history-limit 14 \
            --output-json output/benchmarks/perf/trend/latest.json \
            --output-markdown output/benchmarks/perf/trend/latest.md \
            --fail-on-regression \
            --fail-on-history-regression

      - name: Store latest report in trend history cache path
        if: always()
        run: |
          mkdir -p output/benchmarks/perf/trend/history
          if [ -f output/benchmarks/perf/trend/latest.json ]; then
            cp output/benchmarks/perf/trend/latest.json "output/benchmarks/perf/trend/history/${{ github.run_id }}.json"
          fi

      - name: Upload nightly perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-perf-artifacts
          path: output/benchmarks/perf/
          if-no-files-found: ignore
