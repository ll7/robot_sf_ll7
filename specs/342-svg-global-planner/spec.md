# Feature Specification: SVG-Based Global Planner for Robot Navigation

**Feature Branch**: `342-svg-global-planner`  
**Created**: December 10, 2025  
**Status**: Draft  
**Input**: User description: "Implement automated global planner that generates collision-free waypoint paths from spawn zones to goal zones around static obstacles using visibility graphs"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Basic Path Generation (Priority: P1)

As a researcher running robot navigation experiments, I need the system to automatically generate collision-free paths between spawn and goal zones so that I can quickly set up new navigation scenarios without manually defining waypoints in SVG files.

**Why this priority**: This is the core value proposition - replacing manual waypoint definition with automated path generation. Without this, the feature provides no benefit.

**Independent Test**: Load a map with obstacles and spawn/goal zones, request a path from spawn to goal, verify the returned waypoints avoid all obstacles and connect start to goal.

**Acceptance Scenarios**:

1. **Given** a map with polygon obstacles and defined spawn/goal zones, **When** I request a path from a spawn position to a goal position, **Then** the system returns a list of waypoints that form a collision-free path
2. **Given** a generated path, **When** I verify clearance from obstacles, **Then** all waypoints maintain at least the configured minimum clearance (robot radius + safety margin)
3. **Given** a simple corridor map with no obstacles, **When** I request a path, **Then** the system returns a direct straight-line path

---

### User Story 2 - Map Integration and Compatibility (Priority: P2)

As a developer maintaining existing navigation code, I need the planner to work seamlessly with existing map definitions and navigation components so that I can integrate automated planning without rewriting the navigation system.

**Why this priority**: Ensures backward compatibility and smooth adoption without breaking existing functionality.

**Independent Test**: Use planner output with existing RouteNavigator class, verify it successfully tracks waypoints and triggers destination arrival.

**Acceptance Scenarios**:

1. **Given** existing SVG map files with obstacles and zones, **When** the planner loads these maps, **Then** it correctly extracts obstacle geometries and zone boundaries
2. **Given** a path generated by the planner, **When** I pass it to the existing RouteNavigator, **Then** the navigator successfully tracks progress through waypoints
3. **Given** maps with optional POI markers, **When** POIs are present, **Then** the planner can route through them as intermediate waypoints

---

### User Story 3 - Flexible Start/Goal Selection (Priority: P3)

As a training pipeline developer, I need to generate paths from various start/goal combinations (zone sampling, dynamic positions, POI routing) so that I can create diverse training scenarios and test different navigation challenges.

**Why this priority**: Enables advanced use cases and scenario diversity, but basic planning works without this flexibility.

**Independent Test**: Sample multiple start/goal pairs from zones, verify planner generates valid paths for each combination.

**Acceptance Scenarios**:

1. **Given** spawn and goal zones, **When** I sample random positions from these zones, **Then** the planner generates valid paths for each sampled pair
2. **Given** a current robot position (not from spawn zone), **When** I request a path to a goal, **Then** the planner treats the current position as the start point
3. **Given** POI markers in the map, **When** I request a path with POI routing enabled, **Then** the path passes through specified POIs in a reasonable order

---

### User Story 4 - Performance and Caching (Priority: P4)

As a researcher running large training batches, I need path generation to complete quickly (<100ms) and reuse graph computations across queries so that path planning doesn't become a bottleneck in my experiments.

**Why this priority**: Important for user experience but not required for basic functionality to work.

**Independent Test**: Measure path generation time across 100 queries on a typical map, verify median time is under 100ms and graph is built only once.

**Acceptance Scenarios**:

1. **Given** a map with 50 obstacles, **When** I request a path for the first time, **Then** graph construction and path search complete in under 500ms total
2. **Given** a previously loaded map, **When** I request additional paths, **Then** each query completes in under 100ms (graph reused)
3. **Given** multiple maps in a training session, **When** switching between maps, **Then** the system caches graphs per map to avoid redundant rebuilding

---

### Edge Cases

- **No valid path exists**: When the goal is completely surrounded by obstacles or unreachable, the system raises a PlanningFailedError with diagnostic information about why no path could be found
- **Start/goal inside obstacles**: When sampled positions fall inside obstacle boundaries, the system projects them to the nearest free space before planning
- **Narrow passages**: When paths must traverse gaps smaller than the minimum safe clearance, the system issues a warning but allows the path (configurable behavior)
- **Degenerate maps**: When maps have no obstacles, the system returns a direct straight-line path without building a visibility graph
- **Map changes during runtime**: When obstacle configurations change, cached graphs are invalidated and rebuilt on next query

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST generate waypoint paths that avoid all static polygon obstacles defined in map
- **FR-002**: System MUST support configurable clearance margin beyond robot radius (default: robot_radius + 0.3m)
- **FR-003**: System MUST accept start/goal positions from spawn/goal zones or arbitrary coordinates
- **FR-004**: System MUST return paths as lists of 2D coordinates compatible with existing RouteNavigator
- **FR-005**: System MUST support optional routing through POI (Point of Interest) waypoints defined in SVG maps
- **FR-006**: System MUST provide path smoothing to reduce waypoint count while maintaining obstacle clearance
- **FR-007**: System MUST handle edge cases (no path, start/goal in obstacles, narrow passages) with clear error reporting
- **FR-008**: System MUST support deterministic path generation (same inputs produce same outputs with seeded randomness)
- **FR-009**: System MUST extend SVG parser to recognize POI annotations (circle elements with "poi" class)
- **FR-010**: System MUST provide optional fallback to straight-line paths when planning fails (configurable)

### Key Entities

- **GlobalPlanner**: Main planning component that constructs visibility graphs from obstacles and computes shortest paths
  - Attributes: map definition, clearance margin, smoothing enabled, POI density, iteration limits
  - Relationships: consumes MapDefinition obstacles/zones, produces waypoint lists

- **PlannerConfig**: Configuration dataclass for planner behavior
  - Attributes: clearance margin (meters), max iterations, smoothing enabled, POI density (per square meter)

- **MapDefinition** (existing, extended): Container for SVG-derived map elements
  - Extended attributes: poi_positions (list of Vec2D), optional poi_graph (connectivity info)
  - Existing attributes: obstacles, robot_spawn_zones, robot_goal_zones, robot_routes

- **VisibilityGraph** (internal): Graph representation of collision-free connections
  - Attributes: nodes (obstacle vertices + start/goal), edges (line-of-sight connections)

- **Path**: Sequence of 2D waypoints forming navigation route
  - Attributes: waypoints (list of Vec2D), total length, clearance metrics

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Path generation completes in under 100ms for maps with up to 50 obstacles (median performance)
- **SC-002**: Generated paths maintain minimum clearance of configured margin (robot_radius + safety buffer) from all obstacles
- **SC-003**: System successfully generates valid paths for 100% of existing example maps without errors
- **SC-004**: Path waypoint count is reduced by at least 30% through smoothing while maintaining obstacle clearance
- **SC-005**: Planner output is fully compatible with existing RouteNavigator (no API changes required)
- **SC-006**: Graph construction completes in under 500ms for maps with up to 50 obstacles (one-time cost per map)
- **SC-007**: Test coverage exceeds 90% for planner module (unit and integration tests)
- **SC-008**: Performance benchmarks show no regression in overall simulation speed when using planner-generated routes
- **SC-009**: System handles all edge cases (no path, blocked goals, narrow passages) with appropriate errors or warnings
- **SC-010**: Map authoring time is reduced by 70% compared to manual waypoint definition (based on user testing)

## Assumptions

- Static obstacles only (pedestrians and dynamic obstacles handled by local navigation, not global planner)
- 2D navigation (no multi-level or 3D environments)
- Obstacle geometries are simple polygons without holes or self-intersections
- Robot is approximated as a circular footprint for clearance calculations
- Map coordinate system is Cartesian with consistent units (meters)
- SVG maps use standard coordinate conventions (origin top-left, y-axis down)
- Existing RouteNavigator proximity threshold (typically 1.0m) is sufficient for waypoint tracking
- Training scenarios require deterministic behavior (seeded random sampling)
- Performance targets are based on typical research workstation specs (multi-core CPU, no GPU required for planning)

## Out of Scope

- Dynamic obstacle avoidance (handled by local navigation layer)
- Multi-robot coordination and conflict resolution
- Trajectory optimization (velocity profiles, acceleration limits, curvature constraints)
- 3D or multi-level navigation
- Learning-based planning methods (this is geometry-based only)

## Optional with a very low priority

- Real-time replanning during navigation (paths are pre-computed)
- Interactive path editing or manual waypoint adjustments in UI
- Path cost functions beyond shortest distance (e.g., safety-weighted costs are future work)

## Dependencies

- **Shapely library** (already in use): Required for polygon operations, buffering, and spatial queries
- **NetworkX library**: Required for graph representation and shortest-path algorithms (Dijkstra, A*)
- **pyvisgraph library**: Recommended for visibility graph construction (proven implementation)
- **Existing map parser**: Extends robot_sf/nav/svg_map_parser.py to recognize POI elements
- **Existing navigation**: Integrates with robot_sf/nav/navigation.py and RouteNavigator class
- **SVG map specification**: Requires standardized POI annotation format (circle elements with "poi" class)

## Open Questions

None - all critical decisions have been made based on the detailed design in global-planner-v2.md. The specification is ready for implementation planning.
