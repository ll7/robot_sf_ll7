# Implementation Plan: Map Folder Merge

**Branch**: `001-map-folder-merge` | **Date**: 2025-11-20 | **Spec**: `specs/001-map-folder-merge/spec.md`
**Input**: Feature specification from `/specs/001-map-folder-merge/spec.md`

## Summary

Consolidate duplicate map asset directories (`maps/` and `robot_sf/maps/`) into a single canonical hierarchy under `maps/` (SVG layouts + JSON metadata separated). Provide/strengthen a Map Registry abstraction consumed via existing factory config (`RobotSimulationConfig.map_pool`) so environments resolve maps by ID only; remove any remaining hard-coded path literals. Maintain backward compatibility for all existing map IDs and ensure audit tooling reports zero stray assets post‑migration.

## Technical Context

**Language/Version**: Python 3.11 (uv managed)  
**Primary Dependencies**: Standard library (`pathlib`, `json`, `shutil`), existing `robot_sf` modules (environment_factory, unified_config), logging via Loguru (no new deps)  
**Storage**: File system (SVG + JSON assets); no DB changes  
**Testing**: pytest (unified suite), targeted search/audit tests for stray files  
**Target Platform**: macOS/Linux headless CI (no platform‑specific variation)  
**Project Type**: Library + assets restructuring (no new application tier)  
**Performance Goals**: NFR-001: environment init delta <5% vs baseline; file lookup remains O(1) by ID  
**Constraints**: Backward compatibility for map IDs (Principle VII); reproducibility (Principle I); factory usage only (Principle II); documentation updates (Principle VIII); no prints (Principle XII)  
**Scale/Scope**: Limited to existing map asset set (~dozens of SVG/JSON pairs); no expansion of formats

No fields marked NEEDS CLARIFICATION (spec explicitly states “No clarifications required”). Phase 0 research will still record rationale to satisfy workflow.

## Constitution Check (Pre‑Design)

| Principle | Impact Area | Planned Action | Gate Status |
|-----------|-------------|----------------|-------------|
| I Reproducibility | Asset derivation | Deterministic registry build + audit script | PASS |
| II Factory Abstraction | Env creation | Ensure factories consume registry (no direct file paths) | PASS |
| III Benchmark & Metrics | Indirect | Map changes must not alter episode metric schema | PASS |
| IV Unified Config | Map selection | Only via config `map_pool` IDs; no new ad‑hoc flags | PASS |
| VII Backward Compatibility | Map IDs | Preserve all existing IDs; add validation error listing IDs | PASS |
| VIII Documentation API | Docs | Update `docs/SVG_MAP_EDITOR.md` + root docs index | PASS |
| IX Test Coverage | Behavior | Add audit + negative ID test | PASS |
| XI Library Reuse | Code placement | Introduce/extend registry helper under `robot_sf/maps/registry.py` | PASS |
| XII Logging & Observability | Logging | Use Loguru for migration/audit warnings | PASS |

Violation Noted: Multiple spec directories sharing numeric prefix `001` (tool warning). Outside scope of this feature; will open housekeeping issue but does not block implementation.

## Project Structure

### Documentation (this feature)

```text
specs/001-map-folder-merge/
├── plan.md          # Implementation plan (this file)
├── research.md      # Phase 0: rationale + decisions
├── data-model.md    # Phase 1: entities & relationships
├── quickstart.md    # Phase 1: add-new-map workflow
├── contracts/       # Phase 1: internal map registry contract (OpenAPI abstraction)
└── tasks.md         # Phase 2 (generated by /speckit.tasks later)
```

### Source Code (affected paths)

```text
maps/
└── svg_maps/            # Canonical SVG layouts (destination for all SVG)
robot_sf/maps/
└── metadata/            # (TARGET) JSON metadata relocated here or under maps/metadata/
robot_sf/gym_env/
└── environment_factory.py  # Uses map_pool IDs; will remove any path literals
robot_sf/common/
└── artifact_paths.py    # (May extend) audit helpers
tests/
└── test_maps_registry.py  # New tests (ID validation, audit zero stray files)
```

**Structure Decision**: Keep assets under top-level `maps/` for discoverability; place all JSON metadata in `maps/metadata/` (new) and provide a thin registry module `robot_sf/maps/registry.py` that loads both SVG + JSON by ID. Environment factory remains unchanged externally; internal references switch to registry lookups.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|---------------------------------------|
| Duplicate numeric spec prefixes (001-*) | Historical branches already created; removing now risks losing context | Immediate rename during feature work mixes unrelated concerns; defer via housekeeping issue |

## Constitution Check (Post‑Design Evaluation)

Artifacts created (Phase 1): `research.md`, `data-model.md`, `contracts/openapi.yaml`, `quickstart.md`.

| Principle | Evaluation | Result |
|-----------|------------|--------|
| I Reproducibility | Registry design deterministic; audit tooling planned | PASS |
| II Factory Abstraction | No factory signature changes; internal lookup only | PASS |
| III Benchmark & Metrics | No metric/schema edits introduced | PASS |
| IV Unified Config | Map selection still via `map_pool`; validation added | PASS |
| VII Backward Compatibility | IDs preserved; error messaging defined | PASS |
| VIII Documentation API | Quickstart + planned doc updates enumerated | PASS |
| IX Test Coverage | New tests outlined (`test_maps_registry.py`) | PASS (pending implementation) |
| XI Library Reuse | Registry isolated under `robot_sf/maps/registry.py` (planned) | PASS |
| XII Logging & Observability | Migration/audit to use Loguru (no prints) | PASS |

Outstanding housekeeping item (non-blocking): duplicate numeric spec prefixes; tracked separately.
